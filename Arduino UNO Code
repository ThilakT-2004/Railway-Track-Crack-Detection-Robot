#include <SoftwareSerial.h>

-------- GSM SERIAL --------
SoftwareSerial gsm(12, 13); // RX, TX

-------- MOTOR DRIVER --------
#define ENA 5
#define IN1 8
#define IN2 9
#define IN3 10
#define IN4 11
#define ENB 6

-------- ULTRASONIC --------
#define trig1 2
#define echo1 3
#define trig2 4
#define echo2 7

-------- IR SENSOR --------
#define IR_SENSOR A0

long duration;
int distance1, distance2;
bool messageSent = false;

void setup() {
  pinMode(ENA, OUTPUT);
  pinMode(ENB, OUTPUT);
  pinMode(IN1, OUTPUT);
  pinMode(IN2, OUTPUT);
  pinMode(IN3, OUTPUT);
  pinMode(IN4, OUTPUT);

  pinMode(trig1, OUTPUT);
  pinMode(echo1, INPUT);
  pinMode(trig2, OUTPUT);
  pinMode(echo2, INPUT);

  pinMode(IR_SENSOR, INPUT);

  Serial.begin(9600);
  gsm.begin(9600);

  analogWrite(ENA, 150);
  analogWrite(ENB, 150);

  gsm.println("AT");
  delay(1000);
  gsm.println("AT+CMGF=1");   // SMS text mode
  delay(1000);

  Serial.println("System Ready");
}

void loop() {

  distance1 = getDistance(trig1, echo1);
  distance2 = getDistance(trig2, echo2);
  int irValue = analogRead(IR_SENSOR);

  if ((distance1 < 20 || distance2 < 20) && !messageSent) {
    stopMotors();
    sendSMS("Obstacle detected on track!");
    messageSent = true;
  }
  else if (irValue < 300 && !messageSent) {
    stopMotors();
    sendSMS("âš  Track crack detected! Immediate action required.");
    messageSent = true;
  }
  else {
    moveForward();
    messageSent = false;
  }

  delay(500);
}

-------- FUNCTIONS --------

int getDistance(int trigPin, int echoPin) {
  digitalWrite(trigPin, LOW);
  delayMicroseconds(2);
  digitalWrite(trigPin, HIGH);
  delayMicroseconds(10);
  digitalWrite(trigPin, LOW);
  duration = pulseIn(echoPin, HIGH);
  return duration * 0.034 / 2;
}

void sendSMS(String msg) {
  gsm.println("AT+CMGS=\"+91XXXXXXXXXX\""); // Your phone number
  delay(1000);
  gsm.print(msg);
  delay(500);
  gsm.write(26); // CTRL+Z
  delay(2000);
}

void moveForward() {
  digitalWrite(IN1, HIGH);
  digitalWrite(IN2, LOW);
  digitalWrite(IN3, HIGH);
  digitalWrite(IN4, LOW);
}

void stopMotors() {
  digitalWrite(IN1, LOW);
  digitalWrite(IN2, LOW);
  digitalWrite(IN3, LOW);
  digitalWrite(IN4, LOW);
}
